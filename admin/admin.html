<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CPL Admin Panel</title>
  <link rel="stylesheet" href="assets/style.css">
  <style>
    body {background: #f5f8fc;}
    .admin-flex {display: flex; min-height: 100vh;}
    .sidebar {width: 230px; background: #153e5a; color: #fff; padding: 2rem 1rem; box-shadow: 2px 0px 10px #0001;}
    .sidebar h3 {color: #fff; text-align: center;}
    .nav-section {margin-top:2.2rem;}
    .nav-link {display:block; padding:.7rem 1.1rem; margin:.3rem 0; border-radius:6px; text-decoration:none; color:inherit; font-size: 1.08rem; cursor:pointer;}
    .nav-link.active,.nav-link:hover { background:#216aaa; color:#fff;}
    .main {flex: 1 1 0; padding: 2.5rem 2.5rem; background: #fafcff;}
    .user-bar {text-align:right; margin-bottom: 16px;}
    .logout-btn {background:#e63c3c; color:#fff; border:none; padding:.45em 1.2em; border-radius:6px; margin-left:12px; cursor:pointer;}
    @media(max-width:800px) {.admin-flex{flex-direction:column;}.sidebar{width:100%;}}
  </style>
</head>
<body>
<div class="admin-flex">
  <nav class="sidebar">
    <h3>CPL Admin</h3>
    <div class="nav-section">
      <a class="nav-link active" data-section="tournaments">üèÜ Tournament</a>
      <a class="nav-link" data-section="teams">üë• Team</a>
      <a class="nav-link" data-section="auction">üí∞ Auction</a>
      <a class="nav-link" data-section="match">‚öîÔ∏è Match</a>
    </div>
  </nav>
  <main class="main">
    <div class="user-bar"> <span id="adminStatus"></span> <button class="logout-btn" id="logoutBtn">Logout</button></div>
    <section id="mainContent"> Loading...</section>
  </main>
</div>
<script src="assets/utils.js"></script>
<script>
window.onload = function() {
  // Debug token loading
  const token = getToken();
  console.log("[admin.html] loaded, token:", token);
  if(!token) {
    if(!window.__already_redirected) {
      window.__already_redirected = true;
      window.location = "login.html";
    }
    return;
  }
// ======= SPA NAV AND MAIN LOGIC BELOW =======

document.getElementById('logoutBtn').onclick = function(){ clearToken(); window.location='login.html'; };

const sectionMap = {
  tournaments: renderTournamentSection,
  teams: renderTeamSection,
  auction: renderAuctionSection,
  match: renderMatchSection
};
[...document.querySelectorAll('.nav-link')].forEach(el=>{
  el.onclick=function(){
    document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active'));
    this.classList.add('active');
    const sec = this.dataset.section;
    sectionMap[sec]();
  }
});
function setAdminStatus(){
  document.getElementById('adminStatus').innerText = '(Logged in)';
}
setAdminStatus();

async function renderTournamentSection(){
  let html = `<h2>üèÜ Tournament</h2>`;
  html += `<button id='newTourBtn'>‡¶®‡¶§‡ßÅ‡¶® Tournament ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button><div id='tourCreateWrap'></div><hr>`;
  html += `<div id='tourSelectWrap'></div>`;
  document.getElementById('mainContent').innerHTML=html;
  document.getElementById('newTourBtn').onclick = showTournamentCreateForm;
  loadTournamentList('tourSelectWrap');
}

function showTournamentCreateForm(){
  document.getElementById('tourCreateWrap').innerHTML = `
    <div style='margin-top:1rem;background:#f5faff;padding:1rem 1.5rem;border-radius:9px;'>
      <form id='tourForm'>
        <div class='form-group'><label>Name</label><input type='text' id='name' required></div>
        <div class='form-group'><label>Year</label><input type='number' id='year' required></div>
        <div class='form-group'><label>Start Date</label><input type='date' id='start_date' required></div>
        <div class='form-group'><label>End Date</label><input type='date' id='end_date' required></div>
        <button type='submit'>Create</button>
        <button onclick="document.getElementById('tourCreateWrap').innerHTML=''" type='button' style='margin-left:8px'>Cancel</button>
      </form>
      <div id='tourCreateMsg'></div>
    </div>
  `;
  document.getElementById('tourForm').onsubmit = async function(e){
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    const year = document.getElementById('year').value.trim();
    // Use only date (ISO string) for start/end
    const start = document.getElementById('start_date').value;
    const end = document.getElementById('end_date').value;
    let msg = document.getElementById('tourCreateMsg');
    // Compose ISO full formatted datetime for backend compatibility
    const startDateTime = start ? start+"T00:00:00.000Z" : "";
    const endDateTime = end ? end+"T00:00:00.000Z" : "";
    const res = await apiFetch('/api/v1/admin/tournaments/create', {
      method:'POST',
      headers:{'accept':'application/json','Content-Type':'application/json'},
      body:JSON.stringify({name,year:Number(year),start_date:startDateTime,end_date:endDateTime})
    });
    if(res.ok){ msg.innerHTML = '<span class="success">Tournament created!</span>'; loadTournamentList('tourSelectWrap'); setTimeout(()=>{document.getElementById('tourCreateWrap').innerHTML='';},1200);}
    else msg.innerHTML = '<span class="error">Tournament create failed!</span>';
  };
}

async function loadTournamentList(wrapperId){
  const res = await apiFetch('/api/v1/admin/tournaments/fetch', {headers:{'accept':'application/json'}});
  let html = `<div style='margin-bottom:1.5rem;'> <b>Existing Tournaments:</b><ul style='margin-top:.7rem'>`;
  if(res.ok){
    const tlist = await res.json();
    for(const t of tlist) html += `<li>${t.name} (${t.year})</li>`;
    html += '</ul></div>';
  } else html += "<span class='error'>Load failed!</span></div>";
  document.getElementById(wrapperId).innerHTML = html;
}

// --- Team Section ---
async function renderTeamSection(){
  let html = `<h2>üë• Team Create</h2>`;
  html += `<div id='teamCreateWrap'></div><div id='teamListWrap'></div>`;
  document.getElementById('mainContent').innerHTML = html;
  showTeamCreateForm();
  loadTeamList('teamListWrap');
}

function showTeamCreateForm(){
  document.getElementById('teamCreateWrap').innerHTML = `
    <form id='teamForm'>
      <div class='form-group'><label>Tournament</label><select id='team_tour'></select></div>
      <div class='form-group'><label>Team Name</label><input type='text' id='teamName' required></div>
      <div class='form-group'><label>Team Code</label><input type='text' id='teamCode' required></div>
      <button type='submit'>Create Team</button>
    </form>
    <div id='teamFormMsg'></div>
  `;
  fillTournamentsDropdown('team_tour');
  document.getElementById('teamForm').onsubmit = async function(e){
    e.preventDefault();
    const tid = document.getElementById('team_tour').value;
    const team_name = document.getElementById('teamName').value.trim();
    const team_code = document.getElementById('teamCode').value.trim();
    let msg = document.getElementById('teamFormMsg');
    const res = await apiFetch('/api/v1/admin/teams',{
      method:'POST', headers:{'accept':'application/json','Content-Type':'application/json'},
      body:JSON.stringify({tournament_id:Number(tid),team_name,team_code})
    });
    if(res.ok){ msg.innerHTML = '<span class="success">Team created!</span>'; loadTeamList('teamListWrap');}
    else msg.innerHTML = '<span class="error">Team create failed!</span>';
  };
}
async function fillTournamentsDropdown(selId){
  const res = await apiFetch('/api/v1/admin/tournaments/fetch', {headers:{'accept':'application/json'}});
  const sel = document.getElementById(selId); sel.innerHTML = '';
  if(res.ok){ const list = await res.json(); list.forEach(t=>{const opt=document.createElement('option'); opt.value=t.id; opt.textContent=t.name+' ('+t.year+')';sel.appendChild(opt);});}
}
async function loadTeamList(wrapId){
  // tournament select
  let html = `<div style='margin-top:2rem;'><label>Select Tournament:</label> <select id='teamListTour'></select></div>
    <ul id='teamListItems'></ul>`;
  document.getElementById(wrapId).innerHTML = html;
  await fillTournamentsDropdown('teamListTour');
  async function load(){
    const tid = document.getElementById('teamListTour').value;
    const ul = document.getElementById('teamListItems');
    const res = await apiFetch(`/api/v1/admin/tournaments/${tid}/teams`, {headers:{'accept':'application/json'}});
    if(res.ok){ const tms = await res.json(); ul.innerHTML = tms.map(team=>`<li>${team.team_name} (${team.team_code})</li>`).join('');}
    else ul.innerHTML = '<li>Load failed</li>';
  }
  document.getElementById('teamListTour').onchange = load; load();
}

// --- Auction Section --- (Player selection)
async function renderAuctionSection(){
  let html = `<h2>üí∞ Auction Player Select</h2>`;
  html += `<div id='auctionSelWrap'></div><div id='auctionListWrap'></div>`;
  document.getElementById('mainContent').innerHTML = html;
  showAuctionPlayerSelectForm();
}
function showAuctionPlayerSelectForm(){
  document.getElementById('auctionSelWrap').innerHTML = `
    <form id='auctionSelForm'>
      <div class='form-group'><label>Tournament:</label><select id='auction_tour'></select></div>
      <div class='form-group'><label>Players (multi-select):</label><div id='playerList' class='list-group'></div></div>
      <button type='submit'>Select Players for Auction</button>
    </form>
    <div id='auctionSelMsg'></div>
  `;
  fillTournamentsDropdown('auction_tour').then(()=>loadAllPlayers('auction_tour','playerList'));
  document.getElementById('auction_tour').onchange = ()=>loadAllPlayers('auction_tour','playerList');
  async function loadAllPlayers(tourSelId, playerDivId){
    const res = await apiFetch('/api/v1/adminall/players', {headers:{'accept':'application/json'}});
    const div = document.getElementById(playerDivId); div.innerHTML = '';
    if(!res.ok){div.innerHTML='<div class="error">Player fetch failed</div>';return;}
    const data = await res.json();
    data.forEach(p=>{
      const d=document.createElement('div');d.className='list-group-item'; d.textContent=p.name + ' (#'+p.id+')';d.dataset.id=p.id;d.onclick=function(){d.classList.toggle('selected');};div.appendChild(d);
    });
  }
  document.getElementById('auctionSelForm').onsubmit = async function(e){
    e.preventDefault();
    const tid = document.getElementById('auction_tour').value;
    const ids = Array.from(document.querySelectorAll('.list-group-item.selected')).map(d => Number(d.dataset.id));
    let msgDiv = document.getElementById('auctionSelMsg');
    if(!tid||!ids.length){msgDiv.innerHTML='Tournament ‡¶ì Player select ‡¶ï‡¶∞‡ßÅ‡¶®!';return;}
    const res = await apiFetch(`/api/v1/admin/auction/select-players?tournament_id=${tid}`,{method:'POST',headers:{'accept':'application/json','Content-Type':'application/json'}, body:JSON.stringify(ids)});
    if(res.ok){msgDiv.innerHTML = '<span class="success">Player selected for auction!</span>'; }
    else msgDiv.innerHTML = '<span class="error">Auction selection failed!</span>';
  }
}
function renderMatchSection(){
  document.getElementById('mainContent').innerHTML = `<h2>‚öîÔ∏è Match Management</h2><p>Match add/edit features coming soon...</p>`;
}
renderTournamentSection();
}
</script>
</body>
</html>
