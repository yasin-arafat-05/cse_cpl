<!-- admin/auction_player_select.html -->
<!DOCTYPE html>
<html>
<head>
  <title>Player Selection | Admin Panel</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
<div class="container">
  <div class="heading">Player নির্বাচন (Auction)</div>
  <div class="form-group">
    <label for="tournamentSelect">Tournament:</label>
    <select id="tournamentSelect"></select>
  </div>
  <div class="form-group">
    <label for="token">Admin Token:</label>
    <input type="text" id="token" name="token" placeholder="(Bearer ...)" required>
  </div>
  <div class="form-group">
    <label>Player List (press/hold & select):</label>
    <div id="playerList" class="list-group"></div>
  </div>
  <button id="selectBtn">Select Players</button>
  <div id="result"></div>
  <hr>
  <button onclick="window.location='index.html'">Back</button>
</div>
<script src="assets/utils.js"></script>
<script>
// Tournament dropdown load
async function loadTournaments() {
  const res = await apiFetch('/api/v1/admin/tournaments/fetch', {headers:{'accept':'application/json'}});
  const sel = document.getElementById('tournamentSelect');
  sel.innerHTML = '';
  if (!res.ok) {
    sel.innerHTML = `<option value="">লোড হয়নি (${res.status})</option>`;
    return;
  }
  const data = await res.json();
  if (!data.length) {
    sel.innerHTML = `<option value="">কোন Tournament নেই</option>`;
    return;
  }
  data.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t.id;
    opt.textContent = t.name + ' (' + t.year + ')';
    sel.appendChild(opt);
  });
  loadPlayers(data[0].id);
}

async function loadPlayers(tournamentId) {
  const res = await apiFetch('/api/v1/adminall/players', {headers:{'accept':'application/json'}});
  const parent = document.getElementById('playerList');
  parent.innerHTML = '';
  if (!res.ok) { parent.innerHTML = `<div class='error'>Could not load (${res.status})</div>`; return; }
  const data = await res.json();
  data.forEach(p => {
    const d = document.createElement('div');
    d.className = 'list-group-item';
    d.textContent = p.name + ' (#'+p.id+')';
    d.dataset.id = p.id;
    d.onclick = function() {
      d.classList.toggle('selected');
    };
    parent.appendChild(d);
  });
}

window.onload = () => {
 loadTournaments();
 document.getElementById('tournamentSelect').onchange = function() {
   loadPlayers(this.value);
 };
};

document.getElementById('selectBtn').onclick = async function() {
  const tid = document.getElementById('tournamentSelect').value;
  const token = document.getElementById('token').value.trim();
  const playerIds = Array.from(document.querySelectorAll('.list-group-item.selected')).map(d => Number(d.dataset.id));
  if (!tid || !playerIds.length || !token) {document.getElementById('result').innerHTML='Select tournament, player & token!';return;}
  const res = await apiFetch(`/api/v1/admin/auction/select-players?tournament_id=${tid}`, {
    method: 'POST',
    headers: {
      'accept': 'application/json',
      'Authorization': token,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(playerIds)
  });
  if(res.ok) {
    document.getElementById('result').innerHTML = `<span class='success'>Player selected for tournament!</span>`;
    setTimeout(()=>window.location='auction_player_edit.html?tid='+tid, 1200);
  } else {
    document.getElementById('result').innerHTML = '<span class="error">Failed: '+res.status+'</span>';
  }
}
</script>
</body>
</html>
